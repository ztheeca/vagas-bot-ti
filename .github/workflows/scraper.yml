name: Bot Vagas TI

on:
  schedule:
    # â° HORÃRIOS AGENDADOS (UTC)
    # 11h UTC = 8h BrasÃ­lia | 14h UTC = 11h BrasÃ­lia | 17h UTC = 14h BrasÃ­lia | 20h UTC = 17h BrasÃ­lia | 23h UTC = 20h BrasÃ­lia
    - cron: '0 11,14,17,20,23 * * *'
  workflow_dispatch:  # Permite executar manualmente

jobs:
  buscar-vagas:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸŒ Instalar Chromium e ChromeDriver
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver
        # Instalar dependÃªncias de library para Chromium rodar corretamente
        sudo apt-get install -y libxss1 libappindicator1 libindicator7
        
    - name: âœ… Verificar instalaÃ§Ãµes
      run: |
        echo "âœ… Chromium:"
        chromium-browser --version
        echo "âœ… ChromeDriver:"
        chromedriver --version
        echo "âœ… Python:"
        python --version
        
    - name: ğŸ“¦ Instalar dependÃªncias Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ­ Verificar arquivo .env (nÃ£o usar secrets aqui)
      run: |
        # O script vai usar variÃ¡veis de ambiente, nÃ£o .env
        echo "VariÃ¡veis configuradas via GitHub Secrets"
        
    - name: ğŸš€ Executar Bot de Vagas com Retry
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        LOCAL: "Salvador, BA"
        PYTHONUNBUFFERED: 1
      run: |
        echo "ğŸš€ Iniciando busca automÃ¡tica de vagas..."
        python bot_vagas.py || true
        echo "âœ… Busca concluÃ­da!"
        
    - name: ğŸ“Š Logs da ExecuÃ§Ã£o
      if: always()
      run: |
        echo "Job finalizado em: $(date)"
        echo "Status: ${{ job.status }}"
        
    - name: âŒ Notificar Erro no Discord
      if: failure()
      run: |
        curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "content": "âŒ **Erro na busca de vagas!**",
            "embeds": [{
              "title": "Bot de Vagas TI",
              "description": "Falha ao executar busca automÃ¡tica",
              "color": 16711680,
              "fields": [
                {"name": "Status", "value": "Erro", "inline": true},
                {"name": "Timestamp", "value": "'$(date)'", "inline": true}
              ]
            }]
          }' || true
