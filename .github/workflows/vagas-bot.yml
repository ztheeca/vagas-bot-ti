name: Bot Vagas TI

on:
  schedule:
    # ‚è∞ HOR√ÅRIOS AGENDADOS (UTC)
    # 11h UTC = 8h Bras√≠lia | 14h UTC = 11h Bras√≠lia | 17h UTC = 14h Bras√≠lia | 20h UTC = 17h Bras√≠lia | 23h UTC = 20h Bras√≠lia
    - cron: '0 11,14,17,20,23 * * *'
  workflow_dispatch:  # Permite executar manualmente

name: Bot Vagas TI

on:
  schedule:
    - cron: '0 11,14,17,20,23 * * *'
  workflow_dispatch:

jobs:
  buscar-vagas:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: üêç Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: üìÇ Listar arquivos da raiz
      run: |
        echo "=== ARQUIVOS NA RAIZ ==="
        ls -la
        echo ""
        echo "=== VERIFICAR bot_vagas.py ==="
        if [ -f "scripts/bot_vagas.py" ]; then
          echo "‚úÖ scripts/bot_vagas.py ENCONTRADO"
          wc -l scripts/bot_vagas.py
        else
          echo "‚ùå scripts/bot_vagas.py N√ÉO ENCONTRADO"
          find . -name "*vagas*" -type f
        fi
        
    - name: üìÑ Verificar requirements.txt
      run: |
        echo "=== CONTE√öDO DE requirements.txt ==="
        if [ -f "requirements.txt" ]; then
          cat requirements.txt
        else
          echo "‚ùå requirements.txt N√ÉO ENCONTRADO"
        fi
        
    - name: üåê Instalar Chromium
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver
        sudo apt-get install -y libxss1 fonts-liberation xdg-utils
        
    - name: ‚úÖ Verificar instala√ß√µes
      run: |
        echo "=== VERIFICANDO INSTALA√á√ïES ==="
        echo "Chromium:"
        chromium-browser --version
        echo "ChromeDriver:"
        chromedriver --version
        echo "Python:"
        python --version
        
    - name: üì¶ Instalar depend√™ncias Python
      run: |
        echo "=== INSTALANDO DEPEND√äNCIAS ==="
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo ""
        echo "=== PACOTES INSTALADOS ==="
        pip list | grep -E "selenium|requests|dotenv|webdriver"
        
    - name: üîç Verificar sintaxe do script
      run: |
        echo "=== VERIFICANDO SINTAXE ==="
        python -m py_compile scripts/bot_vagas.py
        if [ $? -eq 0 ]; then
          echo "‚úÖ Sintaxe OK"
        else
          echo "‚ùå ERRO DE SINTAXE"
          exit 1
        fi
        
    - name: üöÄ Executar Bot de Vagas
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        LOCAL: "Salvador, BA"
        PYTHONUNBUFFERED: 1
      run: |
        echo "=== INICIANDO SCRIPT ==="
        echo "Timestamp: $(date)"
        echo "LOCAL: $LOCAL"
        echo "DISCORD_WEBHOOK_URL configurado: $([ -n "$DISCORD_WEBHOOK_URL" ] && echo 'SIM' || echo 'N√ÉO')"
        echo ""
        echo "=== EXECUTANDO ==="
        python scripts/bot_vagas.py
        echo ""
        echo "=== SCRIPT FINALIZADO ==="
        echo "Exit code: $?"
        
    - name: ‚úÖ Sucesso
      if: success()
      run: |
        echo "‚úÖ Bot executado com sucesso!"
        echo "Timestamp: $(date)"
        
    - name: ‚ùå Erro - Debug
      if: failure()
      run: |
        echo "‚ùå FALHA NA EXECU√á√ÉO"
        echo ""
        echo "CHECKLIST:"
        echo "1. bot_vagas.py existe? $([ -f 'scripts/bot_vagas.py' ] && echo 'SIM ‚úÖ' || echo 'N√ÉO ‚ùå')"
        echo "2. requirements.txt existe? $([ -f 'requirements.txt' ] && echo 'SIM ‚úÖ' || echo 'N√ÉO ‚ùå')"
        echo "3. DISCORD_WEBHOOK_URL configurado? $([ -n '${{ secrets.DISCORD_WEBHOOK_URL }}' ] && echo 'SIM ‚úÖ' || echo 'N√ÉO ‚ùå')"
        echo "4. Chrome instalado? $(which chromium-browser > /dev/null && echo 'SIM ‚úÖ' || echo 'N√ÉO ‚ùå')"
        echo ""
        echo "Verifique os logs acima para mais detalhes!"
